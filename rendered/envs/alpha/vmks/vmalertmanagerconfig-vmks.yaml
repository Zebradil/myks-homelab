apiVersion: operator.victoriametrics.com/v1beta1
kind: VMAlertmanagerConfig
metadata:
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
  labels:
    app.kubernetes.io/component: victoria-metrics-k8s-stack-alertmanager
    app.kubernetes.io/instance: vmks
    app.kubernetes.io/name: victoria-metrics-k8s-stack
  name: vmks
  namespace: vmks
spec:
  inhibit_rules:
    - equal:
        - namespace
        - alertname
      source_matchers:
        - severity=critical
      target_matchers:
        - severity=~"warning|info"
    - equal:
        - namespace
        - alertname
      source_matchers:
        - severity=warning
      target_matchers:
        - severity=info
    - equal:
        - namespace
      source_matchers:
        - alertname=InfoInhibitor
      target_matchers:
        - severity=info
  receivers:
    - name: blackhole
    - name: healthchecks
      webhook_configs:
        - url_secret:
            key: healthchecksPing.url
            name: vmks-secrets
    - name: tg-high-severity
      telegram_configs:
        - api_url: http://echo.echo.svc.cluster.local
          bot_token:
            key: telegram.botToken
            name: vmks-secrets
          chat_id: ref+sops://static/0.sops.yaml#/telegram/chatId+
          message: '{{- template "telegram.message" . -}}'
          message_thread_id: ref+sops://static/0.sops.yaml#/telegram/highSeverityTopicId+
          parse_mode: HTML
    - name: tg-common
      telegram_configs:
        - api_url: http://echo.echo.svc.cluster.local
          bot_token:
            key: telegram.botToken
            name: vmks-secrets
          chat_id: ref+sops://static/0.sops.yaml#/telegram/chatId+
          disable_notifications: true
          message: '{{- template "telegram.message" . -}}'
          message_thread_id: ref+sops://static/0.sops.yaml#/telegram/commonTopicId+
          parse_mode: HTML
  route:
    group_by:
      - alertgroup
      - alertname
      - severity
    group_interval: 5m
    group_wait: 30s
    receiver: blackhole
    repeat_interval: 12h
    routes:
      - continue: false
        matchers:
          - alertname="Watchdog"
        receiver: healthchecks
      - continue: false
        matchers:
          - severity="critical"
        receiver: tg-high-severity
      - continue: false
        receiver: tg-common
