apiVersion: apps/v1
kind: DaemonSet
metadata:
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
  name: k3s-private-registries-writer
spec:
  selector:
    matchLabels:
      app: k3s-private-registries-writer
  template:
    metadata:
      annotations:
        checksum/config: 8f7e1c19e1a540c4e4965325d720cee8
      labels:
        app: k3s-private-registries-writer
    spec:
      containers:
        - image: registry.k8s.io/pause:3.10.1
          name: pause
      initContainers:
        - args:
            - |
              set -e

              SOURCE_FILE="/config/registries.yaml"
              TARGET_DIR="/etc/rancher/k3s"
              TARGET_FILE="${TARGET_DIR}/registries.yaml"
              TEMP_FILE="/tmp/registries.yaml.new"

              echo "Creating directory if it doesn't exist..."
              mkdir -p "${TARGET_DIR}"

              # Copy new config to temp location first
              cp "${SOURCE_FILE}" "${TEMP_FILE}"

              # Function to mask secrets in YAML files using yq
              mask_secrets() {
                yq eval '
                  (.. | select(has("auth")) | .auth.username) = "<REDACTED>" |
                  (.. | select(has("auth")) | .auth.password) = "<REDACTED>" |
                  (.. | select(has("auth")) | .auth.token) = "<REDACTED>"
                ' "$1"
              }

              # Show diff if old file exists
              if [ -f "${TARGET_FILE}" ]; then
                echo "Comparing old and new configurations..."

                # Create masked versions for diff
                OLD_MASKED_FILE="/tmp/old_masked.yaml"
                NEW_MASKED_FILE="/tmp/new_masked.yaml"

                mask_secrets "${TARGET_FILE}" > "${OLD_MASKED_FILE}"
                mask_secrets "${TEMP_FILE}" > "${NEW_MASKED_FILE}"

                if diff -u --label "OLD ${TARGET_FILE}" "${OLD_MASKED_FILE}" --label "NEW ${TARGET_FILE}" "${NEW_MASKED_FILE}"; then
                  echo "No changes detected in configuration"
                else
                  echo "Configuration changes detected (secrets redacted in diff above)"
                fi

                # Cleanup temp files
                rm -f "${OLD_MASKED_FILE}" "${NEW_MASKED_FILE}"
              else
                echo "Creating new registries configuration file"
                echo "New configuration preview (secrets redacted):"
                mask_secrets "${TEMP_FILE}" | sed 's/^/  /'
              fi

              # Move new file to final location
              echo "Writing registries configuration..."
              mv "${TEMP_FILE}" "${TARGET_FILE}"

              echo "Configuration written successfully to ${TARGET_FILE}"
              echo "File permissions:"
              ls -la "${TARGET_FILE}"
              echo "Task completed successfully"
          command:
            - /bin/sh
            - -c
          image: mikefarah/yq:4.44.1
          name: registry-config-writer
          securityContext:
            runAsGroup: 0
            runAsUser: 0
          volumeMounts:
            - mountPath: /config
              name: config
              readOnly: true
            - mountPath: /etc/rancher/k3s
              name: host-k3s-config
      tolerations:
        - effect: NoSchedule
          operator: Exists
        - effect: NoExecute
          operator: Exists
      volumes:
        - configMap:
            name: k3s-private-registries-config
          name: config
        - hostPath:
            path: /etc/rancher/k3s
            type: DirectoryOrCreate
          name: host-k3s-config
