apiVersion: v1
data:
  context: |
    argocdUrl: https://argocd.zebradil.dev
  service.telegram: |
    token: $telegram-token
  service.webhook.telegram-html: |
    url: https://api.telegram.org/bot$telegram-token/sendMessage
    headers:
      - name: Content-Type
        value: application/json
  subscriptions: |
    - recipients:
      - telegram-html
      triggers:
      - on-created
      - on-deleted
      - on-deployed
      - on-health-degraded
      - on-sync-failed
      - on-sync-running
      - on-sync-status-unknown
      - on-sync-succeeded
  template.app-created: |
    webhook:
      telegram-html:
        method: POST
        body: '{"chat_id":"ref+sops://static/1.sops.yaml#/telegram/chatId+","message_thread_id":"ref+sops://static/1.sops.yaml#/telegram/topicId+","parse_mode":"HTML","text":"✨ Application \u003cb\u003e\u003ca href=\"{{.context.argocdUrl}}/applications/{{.app.metadata.name}}\"\u003e{{.app.metadata.name}}\u003c/a\u003e\u003c/b\u003e has been created.\n"}'
  template.app-deleted: |
    webhook:
      telegram-html:
        method: POST
        body: '{"chat_id":"ref+sops://static/1.sops.yaml#/telegram/chatId+","message_thread_id":"ref+sops://static/1.sops.yaml#/telegram/topicId+","parse_mode":"HTML","text":"❌Application \u003cb\u003e\u003ca href=\"{{.context.argocdUrl}}/applications/{{.app.metadata.name}}\"\u003e{{.app.metadata.name}}\u003c/a\u003e\u003c/b\u003e has been deleted.\n"}'
  template.app-deployed: |
    webhook:
      telegram-html:
        method: POST
        body: '{"chat_id":"ref+sops://static/1.sops.yaml#/telegram/chatId+","message_thread_id":"ref+sops://static/1.sops.yaml#/telegram/topicId+","parse_mode":"HTML","text":"✅ Application \u003cb\u003e\u003ca href=\"{{.context.argocdUrl}}/applications/{{.app.metadata.name}}\"\u003e{{.app.metadata.name}}\u003c/a\u003e\u003c/b\u003e is now running new version of deployments manifests.\n"}'
  template.app-health-degraded: |
    webhook:
      telegram-html:
        method: POST
        body: "{\"chat_id\":\"ref+sops://static/1.sops.yaml#/telegram/chatId+\",\"message_thread_id\":\"ref+sops://static/1.sops.yaml#/telegram/topicId+\",\"parse_mode\":\"HTML\",\"text\":\"\U0001F494 Application \\u003cb\\u003e\\u003ca href=\\\"{{.context.argocdUrl}}/applications/{{.app.metadata.name}}\\\"\\u003e{{.app.metadata.name}}\\u003c/a\\u003e\\u003c/b\\u003e has degraded.\\n\"}"
  template.app-sync-failed: |
    webhook:
      telegram-html:
        method: POST
        body: '{"chat_id":"ref+sops://static/1.sops.yaml#/telegram/chatId+","message_thread_id":"ref+sops://static/1.sops.yaml#/telegram/topicId+","parse_mode":"HTML","text":"⚠️ The sync operation of application \u003cb\u003e\u003ca href=\"{{.context.argocdUrl}}/applications/{{.app.metadata.name}}?operation=true\"\u003e{{.app.metadata.name}}\u003c/a\u003e\u003c/b\u003e has failed at {{.app.status.operationState.finishedAt}} with the following error: {{.app.status.operationState.message}}\n"}'
  template.app-sync-running: |
    webhook:
      telegram-html:
        method: POST
        body: "{\"chat_id\":\"ref+sops://static/1.sops.yaml#/telegram/chatId+\",\"message_thread_id\":\"ref+sops://static/1.sops.yaml#/telegram/topicId+\",\"parse_mode\":\"HTML\",\"text\":\"\U0001F504 The sync operation of application \\u003cb\\u003e\\u003ca href=\\\"{{.context.argocdUrl}}/applications/{{.app.metadata.name}}?operation=true\\\"\\u003e{{.app.metadata.name}}\\u003c/a\\u003e\\u003c/b\\u003e has started at {{.app.status.operationState.startedAt}}.\\n\"}"
  template.app-sync-status-unknown: |
    webhook:
      telegram-html:
        method: POST
        body: '{"chat_id":"ref+sops://static/1.sops.yaml#/telegram/chatId+","message_thread_id":"ref+sops://static/1.sops.yaml#/telegram/topicId+","parse_mode":"HTML","text":"❓ Application \u003cb\u003e\u003ca href=\"{{.context.argocdUrl}}/applications/{{.app.metadata.name}}\"\u003e{{.app.metadata.name}}\u003c/a\u003e\u003c/b\u003e sync is ''Unknown''. {{range $c := .app.status.conditions}} * {{$c.message}} {{end}}\n"}'
  template.app-sync-succeeded: |
    webhook:
      telegram-html:
        method: POST
        body: '{"chat_id":"ref+sops://static/1.sops.yaml#/telegram/chatId+","message_thread_id":"ref+sops://static/1.sops.yaml#/telegram/topicId+","parse_mode":"HTML","text":"✅ Application \u003cb\u003e\u003ca href=\"{{.context.argocdUrl}}/applications/{{.app.metadata.name}}?operation=true\"\u003e{{.app.metadata.name}}\u003c/a\u003e\u003c/b\u003e has been successfully synced at {{.app.status.operationState.finishedAt}}.\n"}'
  trigger.on-created: |
    - description: Application is created.
      oncePer: app.metadata.name
      send:
      - app-created
      when: "true"
  trigger.on-deleted: |
    - description: Application is deleted.
      oncePer: app.metadata.name
      send:
      - app-deleted
      when: app.metadata.deletionTimestamp != nil
  trigger.on-deployed: |
    - description: Application is synced and healthy. Triggered once per commit.
      oncePer: app.status.operationState?.syncResult?.revision
      send:
      - app-deployed
      when: app.status.operationState != nil and app.status.operationState.phase in ['Succeeded']
        and app.status.health.status == 'Healthy' and (!time.Parse(app.status.health.lastTransitionTime).Add(1
        * time.Minute).Before(time.Parse(app.status.operationState.finishedAt)) or time.Parse(app.status.health.lastTransitionTime).Before(time.Parse(app.status.operationState.startedAt)))
  trigger.on-health-degraded: |
    - description: Application has degraded
      oncePer: app.status.operationState?.syncResult?.revision
      send:
      - app-health-degraded
      when: app.status.health.status == 'Degraded'
  trigger.on-sync-failed: |
    - description: Application syncing has failed
      oncePer: app.status.operationState?.syncResult?.revision
      send:
      - app-sync-failed
      when: app.status.operationState != nil and app.status.operationState.phase in ['Error',
        'Failed']
  trigger.on-sync-running: |
    - description: Application is being synced
      oncePer: app.status.operationState?.syncResult?.revision
      send:
      - app-sync-running
      when: app.status.operationState != nil and app.status.operationState.phase in ['Running']
  trigger.on-sync-status-unknown: |
    - description: Application status is 'Unknown'
      oncePer: app.status.operationState?.syncResult?.revision
      send:
      - app-sync-status-unknown
      when: app.status.sync.status == 'Unknown'
  trigger.on-sync-succeeded: |
    - description: Application syncing has succeeded
      oncePer: app.status.operationState?.syncResult?.revision
      send:
      - app-sync-succeeded
      when: app.status.operationState != nil and app.status.operationState.phase in ['Succeeded']
kind: ConfigMap
metadata:
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
  labels:
    app.kubernetes.io/component: notifications-controller
    app.kubernetes.io/instance: argocd
    app.kubernetes.io/name: argocd-notifications-controller
    app.kubernetes.io/part-of: argocd
  name: argocd-notifications-cm
  namespace: argocd
