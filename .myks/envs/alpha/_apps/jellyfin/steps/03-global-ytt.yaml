apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jellyfin-cache
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jellyfin-config
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jellyfin-media
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 500Gi
  storageClassName: synology-iscsi-btrfs-retain-media-v1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jellyfin
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: jellyfin
  template:
    metadata:
      labels:
        app: jellyfin
    spec:
      nodeName: junior
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
        supplementalGroups:
        - 105
      containers:
      - name: jellyfin
        image: jellyfin/jellyfin:10.9.0
        securityContext:
          privileged: true
        ports:
        - name: http
          containerPort: 8096
        volumeMounts:
        - name: render-device
          mountPath: /dev/dri/renderD128
        - name: cache
          mountPath: /cache
        - name: config
          mountPath: /config
        - name: media
          mountPath: /media
        livenessProbe:
          httpGet:
            path: /health
            port: http
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health
            port: http
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /health
            port: http
          failureThreshold: 30
          periodSeconds: 5
      - name: filebrowser
        image: filebrowser/filebrowser:v2.29.0
        env:
        - name: FB_DATABASE
          value: /database/database.db
        ports:
        - name: http-fb
          containerPort: 80
        volumeMounts:
        - name: filebrowser-db
          mountPath: /database
        - name: media
          mountPath: /srv/media
        livenessProbe:
          httpGet:
            path: /health
            port: http-fb
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health
            port: http-fb
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /health
            port: http-fb
          failureThreshold: 30
          periodSeconds: 5
      - name: torrent
        image: ghcr.io/hotio/qbittorrent:release-4.6.4
        env:
        - name: WEBUI_PORT
          value: "8080"
        ports:
        - name: http-tr
          containerPort: 8080
        volumeMounts:
        - name: media
          mountPath: /data
        - name: torrent-config
          mountPath: /config
      initContainers:
      - name: wireguard-config
        command:
        - sh
        - -c
        - echo "$WG0_CONF" > /config/wg0.conf
        env:
        - name: WG0_CONF
          valueFrom:
            secretKeyRef:
              key: wg0.conf
              name: jellyfin-wireguard-config
        image: busybox:1.36.1
        volumeMounts:
        - name: wireguard-config
          mountPath: /config
      - name: wireguard
        restartPolicy: Always
        image: ghcr.io/linuxserver/wireguard:v1.0.20210914-ls31
        env:
        - name: PUID
          value: "1000"
        - name: PGID
          value: "1000"
        - name: TZ
          value: Etc/UTC
        securityContext:
          capabilities:
            add:
            - NET_ADMIN
        volumeMounts:
        - name: wireguard-config
          mountPath: /config
      volumes:
      - name: render-device
        hostPath:
          path: /dev/dri/renderD128
          type: CharDevice
      - name: cache
        persistentVolumeClaim:
          claimName: jellyfin-cache
      - name: config
        persistentVolumeClaim:
          claimName: jellyfin-config
      - name: media
        persistentVolumeClaim:
          claimName: jellyfin-media
      - name: filebrowser-db
        persistentVolumeClaim:
          claimName: jellyfin-filebrowser-db
      - name: torrent-config
        persistentVolumeClaim:
          claimName: jellyfin-torrent-config
      - name: wireguard-config
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: jellyfin
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  ports:
  - name: http
    port: 80
    targetPort: http
  selector:
    app: jellyfin
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jellyfin-filebrowser-db
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  name: jellyfin-filebrowser
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  ports:
  - name: http
    port: 80
    targetPort: http-fb
  selector:
    app: jellyfin
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jellyfin-torrent-config
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  name: jellyfin-torrent
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  ports:
  - name: http
    port: 80
    targetPort: http-tr
  selector:
    app: jellyfin
---
apiVersion: v1
kind: Secret
metadata:
  name: jellyfin-wireguard-config
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
type: Opaque
stringData:
  wg0.conf: <path:static/0.sops.yaml#wireguard_config>
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: jellyfin-protected
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  entryPoints:
  - web
  - websecure
  routes:
  - match: Host(`jellyfin.zebradil.dev`) || Host(`jellyfin.gray.zebradil.dev`) || Host(`jellyfin.junior.zebradil.dev`)
    kind: Rule
    middlewares:
    - name: chain-authelia-auth
      namespace: authelia
    services:
    - name: jellyfin
      port: http
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: jellyfin-lan
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  entryPoints:
  - lan-web
  - lan-websecure
  routes:
  - match: Host(`jellyfin.lan.zebradil.dev`) || Host(`jellyfin.gray.lan.zebradil.dev`) || Host(`jellyfin.junior.lan.zebradil.dev`)
    kind: Rule
    services:
    - name: jellyfin
      port: http
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: jellyfin-vpn
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  entryPoints:
  - vpn-web
  - vpn-websecure
  routes:
  - match: Host(`jellyfin.ts.zebradil.dev`) || Host(`jellyfin.gray.ts.zebradil.dev`) || Host(`jellyfin.junior.ts.zebradil.dev`)
    kind: Rule
    services:
    - name: jellyfin
      port: http
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: jellyfin-filebrowser-protected
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  entryPoints:
  - web
  - websecure
  routes:
  - match: Host(`jellyfin-filebrowser.zebradil.dev`) || Host(`jellyfin-filebrowser.gray.zebradil.dev`) || Host(`jellyfin-filebrowser.junior.zebradil.dev`)
    kind: Rule
    middlewares:
    - name: chain-authelia-auth
      namespace: authelia
    services:
    - name: jellyfin-filebrowser
      port: http
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: jellyfin-filebrowser-lan
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  entryPoints:
  - lan-web
  - lan-websecure
  routes:
  - match: Host(`jellyfin-filebrowser.lan.zebradil.dev`) || Host(`jellyfin-filebrowser.gray.lan.zebradil.dev`) || Host(`jellyfin-filebrowser.junior.lan.zebradil.dev`)
    kind: Rule
    services:
    - name: jellyfin-filebrowser
      port: http
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: jellyfin-filebrowser-vpn
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  entryPoints:
  - vpn-web
  - vpn-websecure
  routes:
  - match: Host(`jellyfin-filebrowser.ts.zebradil.dev`) || Host(`jellyfin-filebrowser.gray.ts.zebradil.dev`) || Host(`jellyfin-filebrowser.junior.ts.zebradil.dev`)
    kind: Rule
    services:
    - name: jellyfin-filebrowser
      port: http
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: jellyfin-torrent-protected
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  entryPoints:
  - web
  - websecure
  routes:
  - match: Host(`jellyfin-torrent.zebradil.dev`) || Host(`jellyfin-torrent.gray.zebradil.dev`) || Host(`jellyfin-torrent.junior.zebradil.dev`)
    kind: Rule
    middlewares:
    - name: chain-authelia-auth
      namespace: authelia
    services:
    - name: jellyfin-torrent
      port: http
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: jellyfin-torrent-lan
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  entryPoints:
  - lan-web
  - lan-websecure
  routes:
  - match: Host(`jellyfin-torrent.lan.zebradil.dev`) || Host(`jellyfin-torrent.gray.lan.zebradil.dev`) || Host(`jellyfin-torrent.junior.lan.zebradil.dev`)
    kind: Rule
    services:
    - name: jellyfin-torrent
      port: http
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: jellyfin-torrent-vpn
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  entryPoints:
  - vpn-web
  - vpn-websecure
  routes:
  - match: Host(`jellyfin-torrent.ts.zebradil.dev`) || Host(`jellyfin-torrent.gray.ts.zebradil.dev`) || Host(`jellyfin-torrent.junior.ts.zebradil.dev`)
    kind: Rule
    services:
    - name: jellyfin-torrent
      port: http
