apiVersion: v1
kind: ConfigMap
metadata:
  name: config
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
data:
  config.json: '[{"bubble":true,"category":"Services","services":[{"description":"Document management","icon":"paperless","iconBubble":true,"name":"Paperless","newWindow":false,"uri":"https://paperless.zebradil.dev"},{"description":"Media server","icon":"jellyfin","iconBubble":true,"name":"Jellyfin","newWindow":false,"uri":"https://jellyfin.zebradil.dev"},{"description":"Jellyfin media files manager","icon":"filebrowser","iconBubble":true,"name":"Jellyfin Filebrowser","newWindow":false,"uri":"https://jellyfin-filebrowser.zebradil.dev"},{"description":"Jellyfin torrent manager","icon":"qbittorrent","iconBubble":true,"name":"Jellyfin qBittorrent","newWindow":false,"uri":"https://jellyfin-torrent.zebradil.dev"}]},{"bubble":true,"category":"Infra","services":[{"description":"GitOps continuous delivery","icon":"argocd","iconBubble":true,"name":"ArgoCD","newWindow":false,"uri":"https://argocd.zebradil.dev"},{"description":"Authentication and authorization server","icon":"authelia","iconBubble":true,"name":"Authelia","newWindow":false,"uri":"https://auth.zebradil.dev"},{"description":"HTTP reverse proxy and load balancer","icon":"traefik","iconBubble":true,"name":"Traefik","newWindow":false,"uri":"https://traefik.zebradil.dev"},{"description":"Metrics dashboard","icon":"grafana","iconBubble":true,"name":"Grafana","newWindow":false,"uri":"https://zebradil.grafana.net/"},{"description":"Synology NAS","icon":"synology","iconBubble":true,"name":"Synology","newWindow":false,"uri":"https://quickconnect.to/zebradil"}]},{"bubble":true,"category":"Tools","services":[{"description":"Internet speed test","icon":"librespeed","iconBubble":true,"name":"Librespeed","newWindow":false,"uri":"https://librespeed.zebradil.dev"},{"description":"HTTP request/response service","icon":"webtools","iconBubble":true,"name":"Httpbingo","newWindow":false,"uri":"https://httpbingo.zebradil.dev"}]}]'
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: starbase80
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: starbase80
  template:
    metadata:
      labels:
        app.kubernetes.io/name: starbase80
      annotations:
        checksum/config: 3b9ccaef787eb8ec002a9a2d527cfd7e
    spec:
      volumes:
      - name: static
        emptyDir: {}
      - name: config
        configMap:
          name: config
      initContainers:
      - name: builder
        image: jordanroher/starbase-80:1.5.2
        args:
        - sh
        - -c
        - |
          npm run build
          cp -vr public/. /static/
        env:
        - name: TITLE
          value: ""
        volumeMounts:
        - name: static
          mountPath: /static
        - name: config
          mountPath: /app/src/config/config.json
          subPath: config.json
          readOnly: true
      containers:
      - image: nginx:1.26.0
        name: server
        ports:
        - containerPort: 80
          name: http
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            add:
            - NET_BIND_SERVICE
            - CHOWN
            - SETGID
            - SETUID
            drop:
            - all
          privileged: false
        volumeMounts:
        - name: static
          mountPath: /usr/share/nginx/html
          readOnly: true
---
apiVersion: v1
kind: Service
metadata:
  name: starbase80
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  ports:
  - name: http
    port: 80
    targetPort: http
  selector:
    app.kubernetes.io/name: starbase80
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: starbase80-protected
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  entryPoints:
  - web
  - websecure
  routes:
  - match: Host(`starbase80.zebradil.dev`) || Host(`starbase80.gray.zebradil.dev`) || Host(`starbase80.junior.zebradil.dev`)
    kind: Rule
    middlewares:
    - name: chain-authelia-auth
      namespace: authelia
    services:
    - name: starbase80
      port: http
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: starbase80-lan
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  entryPoints:
  - lan-web
  - lan-websecure
  routes:
  - match: Host(`starbase80.lan.zebradil.dev`) || Host(`starbase80.gray.lan.zebradil.dev`) || Host(`starbase80.junior.lan.zebradil.dev`)
    kind: Rule
    services:
    - name: starbase80
      port: http
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: starbase80-vpn
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  entryPoints:
  - vpn-web
  - vpn-websecure
  routes:
  - match: Host(`starbase80.ts.zebradil.dev`) || Host(`starbase80.gray.ts.zebradil.dev`) || Host(`starbase80.junior.ts.zebradil.dev`)
    kind: Rule
    services:
    - name: starbase80
      port: http
