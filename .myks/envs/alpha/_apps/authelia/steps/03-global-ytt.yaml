apiVersion: v1
kind: ConfigMap
metadata:
  name: authelia
  labels:
    app.kubernetes.io/name: authelia
    app.kubernetes.io/instance: authelia
    app.kubernetes.io/version: 4.37.5
    app.kubernetes.io/managed-by: Helm
    helm.sh/chart: authelia-0.8.58
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
data:
  configuration.yaml: "---\ntheme: light\ndefault_redirection_url: https://www.zebradil.dev\ndefault_2fa_method: ''\nserver:\n  host: 0.0.0.0\n  port: 9091\n  asset_path: ''\n  headers:\n    csp_template: ''\n  buffers:\n    read: 4096\n    write: 4096\n  timeouts:\n    read: 6s\n    write: 6s\n    idle: 30s\n  enable_pprof: false\n  enable_expvars: false\nlog:\n  level: info\n  format: text\n  file_path: ''\n  keep_stdout: true\ntotp:\n  disable: false\n  issuer: zebradil.dev\n  algorithm: sha1\n  digits: 6\n  period: 30\n  skew: 1\n  secret_size: 32\nwebauthn:\n  disable: false\n  display_name: Authelia\n  attestation_conveyance_preference: indirect\n  user_verification: preferred\n  timeout: 60s\nntp:\n  address: time.cloudflare.com:123\n  version: 4\n  max_desync: 3s\n  disable_startup_check: false\n  disable_failure: false\nauthentication_backend:\n  password_reset:\n    disable: false\n    custom_url: ''\n  file:\n    path: /config/users_database.yml\n    watch: true\n    search:\n      email: false\n      case_insensitive: false\n    password:\n      algorithm: 'argon2'\n      argon2:\n        variant: 'argon2id'\n        iterations: 3\n        memory: 65536\n        parallelism: 4\n        key_length: 32\n        salt_length: 16\n      scrypt:\n        iterations: 16\n        block_size: 8\n        parallelism: 1\n        key_length: 32\n        salt_length: 16\n      pbkdf2:\n        variant: 'sha512'\n        iterations: 310000\n        salt_length: 16\n      sha2crypt:\n        variant: 'sha512'\n        iterations: 50000\n        salt_length: 16\n      bcrypt:\n        variant: 'standard'\n        cost: 12\npassword_policy:\n  standard:\n    enabled: false\n    min_length: 8\n    max_length: 0\n    require_uppercase: true\n    require_lowercase: true\n    require_number: true\n    require_special: true\n  zxcvbn:\n    enabled: false\n    min_score: 0\nsession:\n  name: 'authelia_session'\n  domain: 'zebradil.dev'\n  same_site: 'lax'\n  expiration: 1h\n  inactivity: 5m\n  remember_me_duration: 1M\nregulation: \n  ban_time: 5m\n  find_time: 2m\n  max_retries: 3\nstorage:\n  local:\n    path: /config/db.sqlite3\nnotifier:\n  disable_startup_check: false\n  smtp:\n    host: smtp.gmail.com\n    port: 587\n    timeout: 5s\n    username: <path:static/smtp.sops.yaml#username>\n    sender: authelia@mail.zebradil.dev\n    identifier: localhost\n    subject: '[Authelia] {title}'\n    startup_check_address: test@authelia.com\n    disable_html_emails: false\n    disable_require_tls: false\n    disable_starttls: false\n    tls:\n      server_name: smtp.gmail.com\n      skip_verify: false\n      minimum_version: TLS1.2\n      maximum_version: TLS1.3\naccess_control:\n  default_policy: two_factor\n...\n"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: authelia
  labels:
    app.kubernetes.io/name: authelia
    app.kubernetes.io/instance: authelia
    app.kubernetes.io/version: 4.37.5
    app.kubernetes.io/managed-by: Helm
    helm.sh/chart: authelia-0.8.58
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  name: authelia
  labels:
    app.kubernetes.io/name: authelia
    app.kubernetes.io/instance: authelia
    app.kubernetes.io/version: 4.37.5
    app.kubernetes.io/managed-by: Helm
    helm.sh/chart: authelia-0.8.58
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  type: ClusterIP
  sessionAffinity: None
  selector:
    app.kubernetes.io/name: authelia
    app.kubernetes.io/instance: authelia
  ports:
  - name: http
    protocol: TCP
    port: 80
    targetPort: http
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: authelia
  labels:
    app.kubernetes.io/name: authelia
    app.kubernetes.io/instance: authelia
    app.kubernetes.io/version: 4.37.5
    app.kubernetes.io/managed-by: Helm
    helm.sh/chart: authelia-0.8.58
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: authelia
      app.kubernetes.io/instance: authelia
  revisionHistoryLimit: 5
  replicas: 1
  minReadySeconds: 0
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
  template:
    metadata:
      labels:
        app.kubernetes.io/name: authelia
        app.kubernetes.io/instance: authelia
        app.kubernetes.io/version: 4.37.5
        app.kubernetes.io/managed-by: Helm
        helm.sh/chart: authelia-0.8.58
      annotations:
        checksum/config: 6e80215eb7b320069bce8eebf898ab7a0fa00fd77fab32fd0ea87d1f676b08c5
    spec:
      hostNetwork: false
      hostPID: false
      hostIPC: false
      affinity:
        nodeAffinity: {}
        podAffinity: {}
        podAntiAffinity: {}
      enableServiceLinks: false
      containers:
      - name: authelia
        image: ghcr.io/authelia/authelia:4.37.5
        imagePullPolicy: IfNotPresent
        command:
        - authelia
        args:
        - --config=/configuration.yaml
        resources:
          limits: {}
          requests: {}
        env:
        - name: AUTHELIA_SERVER_DISABLE_HEALTHCHECK
          value: "true"
        - name: AUTHELIA_JWT_SECRET_FILE
          value: /secrets/JWT_TOKEN
        - name: AUTHELIA_SESSION_SECRET_FILE
          value: /secrets/SESSION_ENCRYPTION_KEY
        - name: AUTHELIA_NOTIFIER_SMTP_PASSWORD_FILE
          value: /secrets/SMTP_PASSWORD
        - name: AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE
          value: /secrets/STORAGE_ENCRYPTION_KEY
        startupProbe:
          failureThreshold: 6
          httpGet:
            path: /api/health
            port: http
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 5
        livenessProbe:
          failureThreshold: 5
          httpGet:
            path: /api/health
            port: http
            scheme: HTTP
          initialDelaySeconds: 0
          periodSeconds: 30
          successThreshold: 1
          timeoutSeconds: 5
        readinessProbe:
          failureThreshold: 5
          httpGet:
            path: /api/health
            port: http
            scheme: HTTP
          initialDelaySeconds: 0
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 5
        ports:
        - name: http
          containerPort: 9091
          protocol: TCP
        volumeMounts:
        - mountPath: /config
          name: authelia
          readOnly: false
        - mountPath: /configuration.yaml
          name: config
          readOnly: true
          subPath: configuration.yaml
        - mountPath: /secrets
          name: secrets
          readOnly: true
      volumes:
      - name: authelia
        persistentVolumeClaim:
          claimName: authelia
      - name: config
        configMap:
          name: authelia
          items:
          - key: configuration.yaml
            path: configuration.yaml
      - name: secrets
        secret:
          secretName: authelia
          items:
          - key: JWT_TOKEN
            path: JWT_TOKEN
          - key: SESSION_ENCRYPTION_KEY
            path: SESSION_ENCRYPTION_KEY
          - key: STORAGE_ENCRYPTION_KEY
            path: STORAGE_ENCRYPTION_KEY
          - key: SMTP_PASSWORD
            path: SMTP_PASSWORD
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: authelia
  labels:
    app.kubernetes.io/name: authelia
    app.kubernetes.io/instance: authelia
    app.kubernetes.io/version: 4.37.5
    app.kubernetes.io/managed-by: Helm
    helm.sh/chart: authelia-0.8.58
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  entryPoints:
  - websecure
  routes:
  - kind: Rule
    match: Host(`auth.zebradil.dev`) && PathPrefix(`/`)
    priority: 10
    middlewares:
    - name: chain-authelia
      namespace: authelia
    services:
    - kind: Service
      name: authelia
      port: 80
      namespace: authelia
      passHostHeader: true
      strategy: RoundRobin
      scheme: http
      weight: 10
      responseForwarding:
        flushInterval: 100ms
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: forwardauth-authelia
  labels:
    app.kubernetes.io/name: authelia
    app.kubernetes.io/instance: authelia
    app.kubernetes.io/version: 4.37.5
    app.kubernetes.io/managed-by: Helm
    helm.sh/chart: authelia-0.8.58
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  forwardAuth:
    address: http://authelia.authelia.svc.cluster.local/api/verify?rd=https://auth.zebradil.dev/
    trustForwardHeader: true
    authResponseHeaders:
    - Remote-User
    - Remote-Name
    - Remote-Email
    - Remote-Groups
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: headers-authelia
  labels:
    app.kubernetes.io/name: authelia
    app.kubernetes.io/instance: authelia
    app.kubernetes.io/version: 4.37.5
    app.kubernetes.io/managed-by: Helm
    helm.sh/chart: authelia-0.8.58
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  headers:
    browserXssFilter: true
    customFrameOptionsValue: SAMEORIGIN
    customResponseHeaders:
      Cache-Control: no-store
      Pragma: no-cache
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: chain-authelia-auth
  labels:
    app.kubernetes.io/name: authelia
    app.kubernetes.io/instance: authelia
    app.kubernetes.io/version: 4.37.5
    app.kubernetes.io/managed-by: Helm
    helm.sh/chart: authelia-0.8.58
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  chain:
    middlewares:
    - name: forwardauth-authelia
      namespace: authelia
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: chain-authelia
  labels:
    app.kubernetes.io/name: authelia
    app.kubernetes.io/instance: authelia
    app.kubernetes.io/version: 4.37.5
    app.kubernetes.io/managed-by: Helm
    helm.sh/chart: authelia-0.8.58
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  chain:
    middlewares:
    - name: headers-authelia
      namespace: authelia
---
apiVersion: v1
kind: Secret
metadata:
  name: authelia
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
stringData:
  JWT_TOKEN: <path:static/0.sops.yaml#JWT_TOKEN>
  SESSION_ENCRYPTION_KEY: <path:static/0.sops.yaml#SESSION_ENCRYPTION_KEY>
  SMTP_PASSWORD: <path:static/smtp.sops.yaml#password>
  STORAGE_ENCRYPTION_KEY: <path:static/0.sops.yaml#STORAGE_ENCRYPTION_KEY>
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: authelia-catch-all
  annotations:
    a8r.io/repository: https://github.com/Zebradil/myks-homelab
spec:
  routes:
  - kind: Rule
    match: PathPrefix(`/`)
    priority: 1
    middlewares:
    - name: chain-authelia-auth
      namespace: authelia
    services:
    - name: starbase80
      namespace: starbase80
      port: http
