# Run `pre-commit run generate-renovate-json` to generate renovate.json from this file.

$schema: https://docs.renovatebot.com/renovate-schema.json
extends:
  - config:best-practices
  - schedule:nonOfficeHours
# Rebase PRs if needed even if there are commits from other bots
gitIgnoredAuthors:
  - renovate[bot]@users.noreply.github.com
  - github-actions[bot]@users.noreply.github.com
packageRules:
  - matchUpdateTypes:
      - minor
      - patch
      - pin
      - digest
    minimumReleaseAge: 7 days
    automerge: true
  - description: Group Helm updates together
    matchPackageNames:
      - helm
      - helm/helm
    groupName: helm
    groupSlug: helm
  - description: Pin latest container image tags
    matchDatasources:
      - docker
    matchCurrentValue: /^latest$/
    rangeStrategy: pin
# Ignore all generated files
ignorePaths:
  - rendered/**
  - .myks/**
customManagers:
  - customType: regex
    managerFilePatterns:
      - /.*/
    matchStrings:
      - # #! renovate: datasource=github-releases depName=helm/helm version=4.0.4
        # lang:regex
        >-
        #! renovate: datasource=(?<datasource>\S+)\s*
        depName=(?<depName>\S+)\s*
        version=(?<currentValue>\S+)
  - customType: regex
    managerFilePatterns:
      - /.*/
    matchStrings:
      - # #! renovate: datasource=docker
        # image: some-registry.io/some-image:1.2.3
        #
        # #! renovate: datasource=docker versioning=semver-coerced
        # image: some-registry.io/some-image:1.2.3-alpha.1
        #
        # By default, the `versioning` option is set to `docker`, which keeps the compatibility suffix: e.g. 1.2-slim.
        # This won't work with versions like 1.2-alpha.1 or 1.2-abcd123.
        # See https://docs.renovatebot.com/modules/versioning/docker/
        # lang:regex
        >-
        #! renovate: datasource=(?<datasource>docker)(?: versioning=(?<versioning>[a-z-]+?))?\s*
        image: ['"]?(?<depName>\S+):(?<currentValue>[^'"\s]+)['"]?
      - # #! renovate: datasource=github-releases depName=argoproj-labs/argocd-vault-plugin
        # version: 1.14.0
        # lang:regex
        >-
        #! renovate: datasource=(?<datasource>\S+) depName=(?<depName>\S+)\s*
        [^\s:]+: ['"]?(?<currentValue>[^'"\s]+)['"]?
  - customType: regex
    managerFilePatterns:
      - /.*/
    matchStrings:
      - # #! renovate: datasource=git-tags
        # url: https://github.com/argoproj/argo-cd
        # version: v2.6.6
        # lang:regex
        >-
        #! renovate: datasource=(?<datasource>\w+)\s*
        url: ['"]?(?<depName>[^'"\s]+)['"]?\s*
        version: ['"]?(?<currentValue>[^'"\s]+)['"]?
      - # #! renovate: datasource=helm
        # name: apisix
        # url: https://charts.apiseven.com
        # version: "1.3.1"
        # lang:regex
        >-
        #! renovate: datasource=(?<datasource>helm)\s*
        name: ['"]?(?<depName>[^'"\s]+)['"]?\s*
        url: ['"]?(?<registryUrl>[^'"\s]+)['"]?\s*
        version: ['"]?(?<currentValue>[^'"\s]+)['"]?
  - customType: regex
    # Helm charts in OCI format require special treatment.
    # In particular, the registry must be a part of the package name.
    # See https://github.com/renovatebot/renovate/discussions/25056#discussioncomment-7200797
    managerFilePatterns:
      - /.*/
    matchStrings:
      - # #! renovate: datasource=docker
        # name: postgresql
        # url: oci://registry-1.docker.io/bitnamicharts
        # version: 13.2.24
        # lang:regex
        >-
        #! renovate: datasource=(?<datasource>docker)\s*
        name: ['"]?(?<product>[^'"\s]+)['"]?\s*
        url: ['"]?oci://(?<namespace>[^'"\s]+)['"]?\s*
        version: ['"]?(?<currentValue>[^'"\s]+)['"]?'
    depNameTemplate: '{{product}}'
    packageNameTemplate: '{{namespace}}/{{product}}'
  # Structured vendir values files
  - customType: jsonata
    fileFormat: yaml
    managerFilePatterns:
      - # lang:regex
        /(^|/)vendir/[^/]+\.yaml$/
    matchStrings:
      - # lang:jsonata
        >-
        $each(prototype.sources, function($v, $k) {
          [
            /* Helm chart from HTTP(S) registry */
            $v.helmChart[$contains(url, /^http/)].{
              "currentValue": version,
              "datasource": "helm",
              "depName": $k,
              "registryUrl": url
            },
            /* Helm chart from OCI registry */
            $v.helmChart[$contains(url, /^oci/)].{
              "currentValue": version,
              "datasource": "docker",
              "depName": $k,
              "packageName": $substring(url, 6) & "/" & name
            },
            /* Git repository */
            $v.git{
              "currentValue": ref,
              "datasource": "git-tags",
              "depName": $k,
              "packageName": url
            }
          ]
        }) ~> $reduce($append, [])
