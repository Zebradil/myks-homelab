#@ load("@ytt:data", "data")
#@ load("@ytt:overlay", "overlay")
#@ load("@ytt:yaml", "yaml")
#@ load("secrets.star", "sec")

#@ def oidc_config():
name: Authelia
issuer: https://auth.zebradil.dev
clientID: #@ sec.sopsy("oidc", "argocd.client_id")
clientSecret: #@ sec.sopsy("oidc", "argocd.client_secret")
cliClientID: #@ sec.sopsy("oidc", "argocd-cli.client_id")
requestedScopes:
  - openid
  - email
  - groups
enableUserInfoGroups: true
userInfoPath: /api/oidc/userinfo
#@ end

#@overlay/match by=overlay.subset({"kind": "ConfigMap", "metadata": {"name": "argocd-cm"}})
#@overlay/match-child-defaults missing_ok=True
---
data:
  application.instanceLabelKey: argocd.argoproj.io/instance
  #! workaround for https://github.com/argoproj/gitops-engine/issues/558
  resource.customizations.ignoreDifferences.apps_Deployment: |
    jqPathExpressions:
      - .spec.template.spec.initContainers[].restartPolicy
  oidc.config: #@ yaml.encode(oidc_config())
