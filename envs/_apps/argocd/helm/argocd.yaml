#@ load("@ytt:data", "data")
#@ load("@ytt:yaml", "yaml")
#@ load("secrets.star", "sops")

#@ d = data.values

#@ def oidc_config():
name: Authelia
issuer: https://auth.zebradil.dev
clientID: #@ sops("oidc", "argocd.client_id")
clientSecret: #@ sops("oidc", "argocd.client_secret")
cliClientID: #@ sops("oidc", "argocd-cli.client_id")
requestedScopes:
  - openid
  - email
  - groups
enableUserInfoGroups: true
userInfoPath: /api/oidc/userinfo
#@ end

---
global:
  domain: #@ d.myks.context.app + "." + d.environment.baseDomain
configs:
  cm:
    url: https://argocd.zebradil.dev
    oidc.config: #@ yaml.encode(oidc_config())
  params:
    server.insecure: 'true'
---
notifications:
  secret:
    items:
      telegram-token: #@ sops("1", "telegram.token")
  notifiers:
    service.telegram: |
      token: $telegram-token
  subscriptions:
    - recipients:
        -  #@ "telegram:" + sops("1", "telegram.fullTopicId")
      triggers:
        - on-created
        - on-deleted
        - on-deployed
        - on-health-degraded
        - on-sync-failed
        - on-sync-running
        - on-sync-status-unknown
        - on-sync-succeeded
  templates: #! lang:yaml
    template.app-created: |
      message: |
        ‚ú® Application *[{{.app.metadata.name}}]({{.context.argocdUrl}}/applications/{{.app.metadata.name}})* has been created.

    template.app-deleted: |
      message: |
        ‚ùå Application *[{{.app.metadata.name}}]({{.context.argocdUrl}}/applications/{{.app.metadata.name}})* has been deleted.

    template.app-deployed: |
      message: |
        ‚úÖ Application *[{{.app.metadata.name}}]({{.context.argocdUrl}}/applications/{{.app.metadata.name}})* is now running new version of deployments manifests.

    template.app-health-degraded: |
      message: |
        üíî Application *[{{.app.metadata.name}}]({{.context.argocdUrl}}/applications/{{.app.metadata.name}})* has degraded.

    template.app-sync-failed: |
      message: |
        ‚ö†Ô∏è The sync operation of application *[{{.app.metadata.name}}]({{.context.argocdUrl}}/applications/{{.app.metadata.name}}?operation=true)* has failed at {{.app.status.operationState.finishedAt}} with the following error: {{.app.status.operationState.message}}

    template.app-sync-running: |
      message: |
        üîÑ The sync operation of application *[{{.app.metadata.name}}]({{.context.argocdUrl}}/applications/{{.app.metadata.name}}?operation=true)* has started at {{.app.status.operationState.startedAt}}.

    template.app-sync-status-unknown: |
      message: |
        ‚ùì Application *[{{.app.metadata.name}}]({{.context.argocdUrl}}/applications/{{.app.metadata.name}})* sync is 'Unknown'.
        {{- range $c := .app.status.conditions }}
        ‚Ä¢ {{ $c.message }}
        {{- end }}

    template.app-sync-succeeded: |
      message: |
        ‚úÖ Application *[{{.app.metadata.name}}]({{.context.argocdUrl}}/applications/{{.app.metadata.name}}?operation=true)* has been successfully synced at {{.app.status.operationState.finishedAt}}.

  triggers: #! lang:yaml
    trigger.on-created: |
      - description: Application is created.
        oncePer: app.metadata.name
        send:
        - app-created
        when: "true"
    trigger.on-deleted: |
      - description: Application is deleted.
        oncePer: app.metadata.name
        send:
        - app-deleted
        when: app.metadata.deletionTimestamp != nil
    trigger.on-deployed: |
      - description: Application is synced and healthy. Triggered once per commit.
        oncePer: app.status.operationState?.syncResult?.revision
        send:
        - app-deployed
        when: app.status.operationState != nil and app.status.operationState.phase in ['Succeeded']
          and app.status.health.status == 'Healthy' and (!time.Parse(app.status.health.lastTransitionTime).Add(1
          * time.Minute).Before(time.Parse(app.status.operationState.finishedAt)) or time.Parse(app.status.health.lastTransitionTime).Before(time.Parse(app.status.operationState.startedAt)))
    trigger.on-health-degraded: |
      - description: Application has degraded
        oncePer: app.status.operationState?.syncResult?.revision
        send:
        - app-health-degraded
        when: app.status.health.status == 'Degraded'
    trigger.on-sync-failed: |
      - description: Application syncing has failed
        oncePer: app.status.operationState?.syncResult?.revision
        send:
        - app-sync-failed
        when: app.status.operationState != nil and app.status.operationState.phase in ['Error',
          'Failed']
    trigger.on-sync-running: |
      - description: Application is being synced
        oncePer: app.status.operationState?.syncResult?.revision
        send:
        - app-sync-running
        when: app.status.operationState != nil and app.status.operationState.phase in ['Running']
    trigger.on-sync-status-unknown: |
      - description: Application status is 'Unknown'
        oncePer: app.status.operationState?.syncResult?.revision
        send:
        - app-sync-status-unknown
        when: app.status.sync.status == 'Unknown'
    trigger.on-sync-succeeded: |
      - description: Application syncing has succeeded
        oncePer: app.status.operationState?.syncResult?.revision
        send:
        - app-sync-succeeded
        when: app.status.operationState != nil and app.status.operationState.phase in ['Succeeded']
