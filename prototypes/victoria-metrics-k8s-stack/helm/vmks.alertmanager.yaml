#@ load("@ytt:data", "data")
#@ load("secrets.star", "sops")

#@ debug_receivers = True

#@ a = data.values.application
---
alertmanager:
  useManagedConfig: true
  config:
    route:
      receiver: 'blackhole'
      group_by: ['alertgroup', 'alertname', 'severity', 'namespace']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
      routes:
        #! Watchdog
        - matchers:
            - alertname="Watchdog"
          receiver: healthchecks
          continue: false
        #! High severity
        - matchers:
            - severity="critical"
          receiver: tg-high-severity
          continue: false

        #! All the rest
        - receiver: tg-common
          continue: false

    inhibit_rules:
      - target_matchers:
          - severity=~"warning|info"
        source_matchers:
          - severity=critical
        equal:
          - namespace
          - alertname
      - target_matchers:
          - severity=info
        source_matchers:
          - severity=warning
        equal:
          - namespace
          - alertname
      - target_matchers:
          - severity=info
        source_matchers:
          - alertname=InfoInhibitor
        equal:
          - namespace

    receivers:
      - name: blackhole
      - name: healthchecks
        webhook_configs:
          - url_secret:
              name: #@ a._.secretName
              key: healthchecksPing.url
      - name: tg-high-severity
        telegram_configs:
          - bot_token:
              name: #@ a._.secretName
              key: telegram.botToken
            chat_id: #@ sops("0", "telegram.chatId")
            message_thread_id: #@ sops("0", "telegram.highSeverityTopicId")
            parse_mode: HTML
            message: '{{- template "telegram.message" . -}}'
          #@ if/end debug_receivers:
          - api_url: 'http://echo.echo.svc.cluster.local'
            bot_token:
              name: #@ a._.secretName
              key: telegram.botToken
            chat_id: #@ sops("0", "telegram.chatId")
            message_thread_id: #@ sops("0", "telegram.highSeverityTopicId")
            parse_mode: HTML
            message: '{{- template "telegram.message" . -}}'
      - name: tg-common
        telegram_configs:
          - bot_token:
              name: #@ a._.secretName
              key: telegram.botToken
            chat_id: #@ sops("0", "telegram.chatId")
            message_thread_id: #@ sops("0", "telegram.commonTopicId")
            disable_notifications: true
            parse_mode: HTML
            message: '{{- template "telegram.message" . -}}'
          #@ if/end debug_receivers:
          - api_url: 'http://echo.echo.svc.cluster.local'
            bot_token:
              name: #@ a._.secretName
              key: telegram.botToken
            chat_id: #@ sops("0", "telegram.chatId")
            message_thread_id: #@ sops("0", "telegram.commonTopicId")
            disable_notifications: true
            parse_mode: HTML
            message: '{{- template "telegram.message" . -}}'

  templateFiles: #! lang:helm
    telegram.tmpl: |
      {{- define "telegram.severity" -}}
      {{- with .Data.CommonLabels -}}
      {{- if eq .severity "critical" -}}
      üö® CRITICAL
      {{- else if eq .severity "warning" -}}
      ‚ö†Ô∏è WARNING
      {{- else if eq .severity "info" -}}
      ‚ÑπÔ∏è INFO
      {{- else -}}
      üîî ALERT
      {{- end -}}
      {{- end -}}
      {{- end -}}

      {{- define "telegram.common" -}}
      {{- template "telegram.severity" . -}}
      {{- with .Data.CommonLabels -}}
      <b>{{- .alertgroup | html }}/{{ .alertname | html }}</b>
      in namespace <i>{{ .namespace | html }}</i>
      {{- end -}}
      {{- end -}}

      {{- define "telegram.alert_list" -}}
      {{- template "telegram.common" . -}}
      {{- range .Alerts -}}
      ---
      {{- with .Annotations.summary }}
      <b>Sum:</b> {{ . | html }}{{ end }}
      {{- with .Labels.pod }}
      <b>Pod:</b> <i>{{ . | html }}</i>{{ end }}
      {{- with .Labels.container }}
      <b>Container:</b> <i>{{ . | html }}</i>{{ end }}
      {{- with .Labels.node }}
      <b>Node:</b> <i>{{ . | html }}</i>{{ end }}
      {{- with .StartsAt }}
      <b>Started at:</b> <i>{{ . | html }}</i>{{ end }}
      {{- with .EndsAt }}
      <b>Ended at:</b> <i>{{ . | html }}</i>{{ end }}

      {{- with .GeneratorURL }}
      <a href="{{ .GeneratorURL }}">Source</a>{{ end }}
      {{- with .Annotations.runbook_url }}
      <a href="{{ . }}">Runbook</a>{{ end }}{{ end }}
      {{- end -}}

      {{- define "telegram.message" }}
      {{- if gt (len .Alerts.Firing) 0 -}}
      üî• Alerts Firing
      {{ template "telegram.alert_list" dict "Data" .Data "Alerts" .Alerts.Firing }}{{ end }}
      {{- if gt (len .Alerts.Resolved) 0 -}}
      ‚úÖ Alerts Resolved
      {{ template "telegram.alert_list" dict "Data" .Data "Alerts" .Alerts.Resolved }}{{ end }}
      <a href="{{ .ExternalURL }}">Alertmanager UI</a>
      {{- end -}}
