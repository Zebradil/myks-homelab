#@ load("@ytt:data", "data")
#@ load("overlay-matchers.star", "matchers")

#@ old_version = data.values.application.postgresql.upgradeMode.fromVersion

#! /opt/bitnami/postgresql/bin/
#! pg_upgrade --old-datadir=/old-postgresql/data --new-datadir=/var/lib/postgresql/data --old-bindir=/old-postgresql/bin --new-bindir=/opt/bitnami/postgresql/bin --check || exit 1
#! pg_upgrade --old-datadir=/old-postgresql/data --new-datadir=/var/lib/postgresql/data --old-bindir=/old-postgresql/bin --new-bindir=/opt/bitnami/postgresql/bin || exit 1

#! pg_upgrade --old-datadir=/bitnami/postgresql/data.13 --new-datadir=/bitnami/postgresql/data --old-bindir=/old-postgresql/bin --new-bindir=/opt/bitnami/postgresql/bin --check || exit 1

#@overlay/match by=matchers.kind_name("StatefulSet", "postgresql")
---
spec:
  template:
    spec:
      #@overlay/match missing_ok=True
      initContainers:
        - name: download-old-postgresql
          image: #@ "docker.io/bitnami/postgresql:" + old_version
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Copying old PostgreSQL binaries..."
              postgres --version
              mkdir -p /old-postgresql
              cp -rv /opt/bitnami/postgresql/bin /old-postgresql/bin
          volumeMounts:
            - name: old-postgresql
              mountPath: /old-postgresql
      containers:
        #@overlay/match by="name"
        - name: postgresql
          #@overlay/match missing_ok=True
          command:
            - /bin/sh
            - -c
            - |
              echo "Setting up environment"
              postgres --version
              . /opt/bitnami/scripts/libos.sh
              ensure_group_exists postgres -i 1001
              ensure_user_exists postgres -i 1001 -g postgres
              echo "Waiting for user"
              tail -f /dev/null
          volumeMounts:
            - name: old-postgresql
              mountPath: /old-postgresql
          #@overlay/remove
          securityContext:
      volumes:
        - name: old-postgresql
          emptyDir: {}
