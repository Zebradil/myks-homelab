#@ load("@ytt:data", "data")
#@ load("@ytt:overlay", "overlay")
#@ load("@ytt:yaml", "yaml")

#@ config_map_name = "cmp-plugin"
#@ service_account = "argocd-repo-server"
#@ sops_age_key_secret = data.values.application._.sopsAgeKeySecretName

---
apiVersion: v1
kind: Secret
metadata:
  name: #@ sops_age_key_secret
type: Opaque
stringData:
  key: NOTHING HERE, SET IT MANUALLY


#! The following overlay is used to add the vals CMP plugin to ArgoCD.
#! It is done by patching the argocd-repo-server deployment in the following way:
#!   1. Mount cmp-plugin configmap, which contains the plugin configuration.
#!   2. Add the vals container, which will run the vals binary.
#!      Additional volumes are mounted to make it work with ArgoCD.
#!   3. Add the download-tools initContainer to download the vals binary,
#!      which is shared with the vals container via the download-tools emptyDir volume.
#@overlay/match by=overlay.subset({"kind": "Deployment", "metadata": {"name": "argocd-repo-server"}})
---
#@overlay/match-child-defaults missing_ok=True
spec:
  template:
    spec:
      serviceAccountName: #@ service_account
      volumes:
        - name: cmp-plugin
          configMap:
            name: #@ config_map_name
        - name: custom-tools
          emptyDir: {}
        - name: cmp-tmp
          emptyDir: {}
      initContainers:
        - name: download-tools
          image: registry.access.redhat.com/ubi8
          env:
            - name: VALS_VERSION
              value: #@ data.values.application.vals.version
          command: [bash, -c]
          args:
            #! lang:bash
            - |
              ARTEFACT="vals_${VALS_VERSION#v}_linux_amd64.tar.gz"
              URL="https://github.com/zebradil/vals/releases/download/$VALS_VERSION/$ARTEFACT"
              curl --show-error --location "$URL" \
                | tar -xzvC /custom-tools vals
          volumeMounts:
            - name: custom-tools
              mountPath: /custom-tools
      containers:
        - name: vals
          command: [/var/run/argocd/argocd-cmp-server]
          image: registry.access.redhat.com/ubi8
          env:
            - name: SOPS_AGE_KEY
              valueFrom:
                secretKeyRef:
                  name: #@ sops_age_key_secret
                  key: key
          securityContext:
            allowPrivilegeEscalation: false
            runAsGroup: 999
            runAsNonRoot: true
            runAsUser: 999
          volumeMounts:
            - name: var-files
              mountPath: /var/run/argocd
            - name: plugins
              mountPath: /home/argocd/cmp-server/plugins
            - name: cmp-tmp
              mountPath: /tmp

            #! Register plugins into sidecar
            - name: cmp-plugin
              mountPath: /home/argocd/cmp-server/config/plugin.yaml
              subPath: plugin.yaml

            #! Important: Mount tools into $PATH
            - name: custom-tools
              mountPath: /usr/local/bin/vals
              subPath: vals

---
#@ def avp_plugin_config():
apiVersion: argoproj.io/v1alpha1
kind: ConfigManagementPlugin
metadata:
  name: vals
spec:
  generate:
    command: ['bash', '-c']
    args:
      #! lang:bash
      - |-
        find \
          -maxdepth 1 \
          -regextype egrep \
          -iregex '.*\.ya?ml$' \
          -type f \
          -printf '---\n' \
          -exec cat {} \; \
        | vals eval


#@ end
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: #@ config_map_name
data:
  plugin.yaml: #@ yaml.encode(avp_plugin_config())
