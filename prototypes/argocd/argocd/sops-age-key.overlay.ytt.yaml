#! This file contains an overlay that adds a rule to ignore differences in the
#! sops age key Secret. The value of the secret must be set and updated manually.

#@ load("@ytt:overlay", "overlay")
#@ load("@ytt:data", "data")

#@ name = data.values.application._.sopsAgeKeySecretName

#@ def by_func(i, l, r):
#@   opts = set([v for v in l])
#@   return i == "syncOptions" and "RespectIgnoreDifferences=true" not in opts
#@ end

#@overlay/match by=overlay.subset({"kind": "Application"})
---
spec:
  #@overlay/match missing_ok=True
  ignoreDifferences:
    - kind: Secret
      name: #@ name
      jqPathExpressions:
        - .data.key
        - .stringData.key
  syncPolicy:
    #@overlay/match by=by_func, when=1
    syncOptions:
      #! This is required to ensure that the secret is not changed when the
      #! application is synced.
      - RespectIgnoreDifferences=true
