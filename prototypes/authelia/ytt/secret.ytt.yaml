#@ load("overlay-matchers.star", "matchers")
#@ load("secrets.star", "sops")
---
apiVersion: v1
kind: Secret
metadata:
  name: authelia
stringData:
  identity_providers.oidc.hmac.key: #@ sops("oidc", "hmac_secret")
  identity_validation.reset_password.jwt.hmac.key: #@ sops("0", "JWT_TOKEN")
  notifier.smtp.password.txt: #@ sops("smtp", "password")
  oidc.jwks.default.key: #@ sops("oidc", "jwks.default.key")
  session.encryption.key: #@ sops("0", "SESSION_ENCRYPTION_KEY")
  storage.encryption.key: #@ sops("0", "STORAGE_ENCRYPTION_KEY")


#! The Deployment has to be updated to add the custom keys

#@overlay/match by=matchers.kind_name("Deployment", "authelia")
---
spec:
  template:
    spec:
      volumes:
        #@overlay/match by="name"
        - name: secrets
          secret:
            items:
              - key: oidc.jwks.default.key
                path: oidc.jwks.default.key
