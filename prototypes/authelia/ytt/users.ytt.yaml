#@ load("@ytt:overlay", "overlay")
#@ load("overlay-matchers.star", "matchers")
#@ load("secrets.star", "sec")

#@ secret_name = "users"
#@ file_name = "users_database.yaml"
---
apiVersion: v1
kind: Secret
metadata:
  name: users
stringData: #@ {file_name: sec.sops("users", "_")}

#@overlay/match by=matchers.kind_name("Deployment", "authelia")
---
spec:
  template:
    metadata:
      annotations:
        #! TODO: implement ytt access to static files and calculate checksum from the original content
        #@overlay/match missing_ok=True
        zebradil.dev/users-checksum: Sat Aug 23 19:43:09 CEST 2025
    spec:
      containers:
        #@overlay/match by="name"
        - name: authelia
          volumeMounts:
            - name: #@ secret_name
              mountPath: #@ "/config/" + file_name
              subPath: #@ file_name
              readOnly: true
      volumes:
        - name: #@ secret_name
          secret:
            secretName: #@ secret_name
